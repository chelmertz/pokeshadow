<!doctype html>
<html lang="en">
<head>
    <title>Pokeshadow</title>
    <style type="text/css">
        html, body {
            margin: 0;
            padding: 0;
        }

        main {
            align-items: center;
            background: repeating-linear-gradient(
                45deg, #f6ba52, #f6ba52 10px, #ffd180 10px, #ffd180 20px
            );
            display: flex;
            flex-direction: column;
            gap: 4vh;
            height: 100vh;
            justify-content: center;
            width: 100vw;
        }

        .treasure {
            align-items: center;
            display: flex;
            flex-direction: row;
            gap: 1vh;
            justify-content: center;
            img {
                width: 4vh;
            }
        }

        .subject {
            filter: brightness(0%);
            transition: all 0.5s linear;
            min-height: 60vh;
            max-width: 70vw;

            &.success {
                filter: brightness(100%);
            }
        }

        .letters, .alternatives {
            display: flex;
            flex-direction: row;
            /* flex in two rows with a max width of 50vw, with even space between items, except the last item which should leave space for the next row */
            flex-wrap: wrap;
            gap: 1vw;
            max-width: 50vw;

            &.failure {
                .letter {
                    border-color: #f00;
                }
            }
            &.success {
                .letter {
                    border-color: #0f0;
                }
            }
        }

        .letter {
            align-items: center;
            background: #fff;
            border: 3px solid #000;
            border-radius: 10px;
            color: goldenrod;
            cursor: pointer;
            display: flex;
            font-size: 24px;
            font-weight: bold;
            height: 4vh;
            justify-content: center;
            user-select: none;
            width: 4vw;
        }
    </style>
</head>

<body>
<main>
<div class="treasure">
<img src="/treasure-chest-svgrepo-com.svg" alt="treasure"/> <span class="points"></span>
</div>
<img class="subject" src="" alt="a random pokÃ©mon for you to catch"/>
<div class="letters"></div>
<div class="alternatives"></div>
</main>
<script type="text/javascript" src="/data.js"></script>
<script type="text/javascript">
const subject = {
    el: document.querySelector('.subject'),
    name: '',
    letters: [],
};

const showSubject = () => {
    subject.el.style.filter = 'brightness(100%)';
}
subject.el.addEventListener('click', showSubject);

/* Randomize array in-place using Durstenfeld shuffle algorithm
from https://stackoverflow.com/questions/2450954/how-to-randomize-shuffle-a-javascript-array
*/
function shuffleArray(arr) {
    for (var i = arr.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = arr[i];
        arr[i] = arr[j];
        arr[j] = temp;
    }
}

const anyLetter = () => String.fromCharCode(Math.floor(Math.random() * 26) + 65);

const addPoints = (pts) => {
    let points = parseInt(localStorage.getItem('points') || 0, 10);
    points += pts;
    localStorage.setItem('points', points);
    document.querySelector('.points').textContent = points;
};
// persist initial value
addPoints(0);

const success = () => {
    document.querySelector('.subject').classList.add('success');
    document.querySelector('.letters').classList.add('success');
    addPoints(10);
    setTimeout(() => {
        document.querySelector('.subject').classList.remove('success');
        document.querySelector('.letters').classList.remove('success');
    }, 2500);
    setTimeout(() => {
        newSubject();
    }, 3000);
};
const failure = () => {
    document.querySelector('.letters').classList.add('failure');
};

const newSubject = () => {
    const svgIndex = Math.floor(Math.random() * Object.keys(svgs).length).toString();
    const filename = svgs[svgIndex];
    const pokemonNumber = filename.replace(/\D+/g, '');
    subject.el.src = `/svg/${filename}`;
    subject.name = pokemon[pokemonNumber].toUpperCase();
    subject.letters = [];
    let letters = subject.name.split('');
    shuffleArray(letters);
    subject.letters = [...letters];
    const lettersToAdd = letters.length % 2 === 0 ? 2 : 3;
    // fill up a bit to make it harder to guess
    for (let i = 0; i < lettersToAdd; i++) {
        subject.letters.push(anyLetter());
    }

    document.querySelector('.letters').innerHTML = '';
    document.querySelector('.alternatives').innerHTML = '';
    console.log(subject.name);

    // render letters.length amount of actual letters in .letters
    for (let i = 0; i < letters.length; i++) {
        const letter = document.createElement('div');
        letter.classList.add('letter');
        letter.innerHTML = ' ';
        letter.addEventListener('click', (l) => {
            if (letter.innerHTML === ' ') {
                return;
            }
            document.querySelector('.letters').classList.remove('failure');
            const alternative = document.querySelectorAll('.alternatives .letter')[letter.dataset.index];
            alternative.innerHTML = letter.innerHTML;
            alternative.style.visibility = '';
            letter.innerHTML = ' ';
        });
        document.querySelector('.letters').appendChild(letter);
    }

    for (let i = 0; i < subject.letters.length; i++) {
        const alternative = document.createElement('div');
        alternative.classList.add('letter');
        alternative.innerHTML = subject.letters[i];
        alternative.addEventListener('click', () => {
            if (alternative.innerHTML === ' ') {
                return;
            }

            let didInsert = false;
            let currentGuess = '';
            const letters = document.querySelectorAll('.letters .letter');
            letters.forEach((l, li) => {
                if (!didInsert && l.innerHTML === ' ') {
                    l.innerHTML = alternative.innerHTML;
                    currentGuess += l.innerHTML;
                    l.dataset.index = i;
                    didInsert = true;
                    if (li == letters.length-1) {
                        if (currentGuess === subject.name) {
                            success();
                        } else {
                            failure();
                        }
                    }
                } else {
                    currentGuess += l.innerHTML;
                }
            });

            if (didInsert) {
                alternative.style.visibility = 'hidden';
            }
        });
        document.querySelector('.alternatives').appendChild(alternative);
    }
};

newSubject();

/*
guessing fsm:

space left in guess -> enter guessed letter
enter guessed letter -> remove/deactivate available letter
enter guessed letter -> render letter in left-most available spot
no space left in guess -> indicate success/failure
remove guessed letter -> activate available letter
remove guessed letter -> clear spot
*/

</script>
</body>
</html>